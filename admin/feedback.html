<!doctype html>
<html lang="uk">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üì¢ Feedback | Destiny Code Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
        }

        .card {
            background: #1e293b;
            border: 1px solid #334155;
        }

        /* Custom scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
    </style>
</head>

<body class="min-h-screen p-4 md:p-8">

    <!-- üîê LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50">
        <div class="card rounded-2xl p-8 w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-white mb-2">üîê Feedback Admin</h2>
            <input type="password" id="password-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å"
                class="w-full px-4 py-3 rounded-lg bg-slate-800 border border-slate-600 text-white text-center text-lg tracking-widest mb-4 focus:outline-none focus:border-indigo-500"
                autofocus />
            <button id="login-btn"
                class="w-full px-4 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-semibold transition">
                –£–≤—ñ–π—Ç–∏
            </button>
        </div>
    </div>

    <!-- üìä DASHBOARD -->
    <div id="admin-content" class="max-w-6xl mx-auto hidden pb-20">
        <div class="flex items-center justify-between mb-8">
            <div>
                <a href="/admin" class="text-indigo-400 hover:text-indigo-300 text-sm mb-1 inline-block">‚Üê –ù–∞–∑–∞–¥ –¥–æ
                    –ú–µ–Ω—é</a>
                <h1 class="text-3xl font-bold text-white">üì¢ Website Feedback</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="loadFeedback()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">üîÑ
                    Refresh</button>
            </div>
        </div>

        <!-- STATS ROW -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <!-- Total -->
            <div class="card rounded-xl p-5 border-l-4 border-indigo-500">
                <div class="text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">–í—Å—å–æ–≥–æ (–æ—Å—Ç–∞–Ω–Ω—ñ 100)</div>
                <div class="text-3xl font-bold text-white" id="stat-total">-</div>
            </div>
            <!-- Likes -->
            <div class="card rounded-xl p-5 border-l-4 border-green-500">
                <div class="text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">üëç –ü–æ–∑–∏—Ç–∏–≤</div>
                <div class="text-3xl font-bold text-white" id="stat-likes">-</div>
            </div>
            <!-- Dislikes -->
            <div class="card rounded-xl p-5 border-l-4 border-red-500">
                <div class="text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">üëé –ù–µ–≥–∞—Ç–∏–≤</div>
                <div class="text-3xl font-bold text-white" id="stat-dislikes">-</div>
            </div>
            <!-- Text Feedback -->
            <div class="card rounded-xl p-5 border-l-4 border-amber-500">
                <div class="text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">üí¨ –¢–µ–∫—Å—Ç</div>
                <div class="text-3xl font-bold text-white" id="stat-text">-</div>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="flex flex-wrap gap-2 mb-6">
            <button onclick="filterFeed('all')" id="btn-all"
                class="filter-btn px-4 py-2 rounded-lg bg-indigo-600 text-white">–í—Å—ñ</button>
            <button onclick="filterFeed('text')" id="btn-text"
                class="filter-btn px-4 py-2 rounded-lg bg-slate-700 text-slate-300">üìù –¢–µ–∫—Å—Ç</button>
            <button onclick="filterFeed('like')" id="btn-like"
                class="filter-btn px-4 py-2 rounded-lg bg-slate-700 text-slate-300">üëç Likes</button>
            <button onclick="filterFeed('dislike')" id="btn-dislike"
                class="filter-btn px-4 py-2 rounded-lg bg-slate-700 text-slate-300">üëé Dislikes</button>
        </div>

        <!-- LIST CONTAINER -->
        <div id="feedback-container" class="space-y-3">
            <div class="text-center py-20 text-slate-500">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            projectId: "destinycode-982fa",
            appId: "1:168629222416:web:3283f6a4051f57a85c9e95",
            storageBucket: "destinycode-982fa.firebasestorage.app",
            apiKey: "AIzaSyA20BvSogSuHTni09Y54HwmlpG7UKXuxk8",
            authDomain: "destinycode-982fa.firebaseapp.com",
            messagingSenderId: "168629222416",
            measurementId: "G-ZKS4RCNFGX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- AUTH ---
        const ADMIN_PASSWORD = '1536';
        const SESSION_KEY = 'dc_admin_auth';

        // üî• FIX: Check session AFTER functions are defined (see bottom of script)

        document.getElementById('login-btn').addEventListener('click', attemptLogin);
        document.getElementById('password-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') attemptLogin();
        });

        function attemptLogin() {
            const pass = document.getElementById('password-input').value;
            if (pass === ADMIN_PASSWORD) {
                sessionStorage.setItem(SESSION_KEY, 'true');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
                loadFeedback();
            } else {
                alert('Wrong password');
            }
        }

        // --- DATA LOGIC ---
        let allItems = [];
        let currentFilter = 'all';

        window.filterFeed = (type) => {
            currentFilter = type;

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-slate-700', 'text-slate-300');
            });
            const activeBtn = document.getElementById(`btn-${type}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-slate-700', 'text-slate-300');
                activeBtn.classList.add('bg-indigo-600', 'text-white');
            }

            renderList();
        };

        window.loadFeedback = async () => {
            const container = document.getElementById('feedback-container');
            container.innerHTML = '<div class="text-center py-20 text-slate-500 animate-pulse">–û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>';

            try {
                // Fetch last 100 items
                const q = query(collection(db, "web_feedback"), orderBy("timestamp", "desc"), limit(100));
                const snapshot = await getDocs(q);

                allItems = [];
                let stats = { total: 0, like: 0, dislike: 0, text: 0 };

                snapshot.forEach(doc => {
                    const data = doc.data();
                    allItems.push({ id: doc.id, ...data });

                    stats.total++;
                    if (data.type === 'like') stats.like++;
                    if (data.type === 'dislike') stats.dislike++;
                    if (data.type === 'text') stats.text++;
                });

                // Update Stats
                document.getElementById('stat-total').innerText = stats.total;
                document.getElementById('stat-likes').innerText = stats.like;
                document.getElementById('stat-dislikes').innerText = stats.dislike;
                document.getElementById('stat-text').innerText = stats.text;

                renderList();

            } catch (e) {
                container.innerHTML = `<div class="text-red-500 text-center">Error: ${e.message}</div>`;
                console.error(e);
            }
        };

        function renderList() {
            const container = document.getElementById('feedback-container');
            container.innerHTML = '';

            const filtered = currentFilter === 'all'
                ? allItems
                : allItems.filter(item => item.type === currentFilter);

            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-slate-600">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üçÉ</div>';
                return;
            }

            filtered.forEach(item => {
                const date = item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleString('uk-UA') : 'No Date';
                const email = item.email || 'Anonymous';
                const source = item.source || 'unknown';

                let sourceBadge = '';
                if (source === 'free_report') sourceBadge = '<span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-slate-600 text-white ml-2">FREE REPORT</span>';
                if (source === 'premium_report') sourceBadge = '<span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-amber-500 text-black ml-2">PREMIUM REPORT</span>';

                let icon = '‚ùì';
                let borderClass = 'border-slate-700';
                let bgClass = 'bg-slate-800/50';

                if (item.type === 'like') { icon = 'üëç'; borderClass = 'border-green-500/30'; bgClass = 'bg-green-900/10'; }
                if (item.type === 'dislike') { icon = 'üëé'; borderClass = 'border-red-500/30'; bgClass = 'bg-red-900/10'; }
                if (item.type === 'text') { icon = 'üí¨'; borderClass = 'border-indigo-500/50'; bgClass = 'bg-indigo-900/10'; }

                const contentHtml = item.type === 'text'
                    ? `<div class="mt-2 text-white bg-slate-900/50 p-3 rounded border border-slate-700 text-sm whitespace-pre-wrap">${escapeHtml(item.value)}</div>`
                    : `<div class="text-slate-500 text-sm italic mt-1">–û—Ü—ñ–Ω–∫–∞: ${item.value}</div>`;

                const card = document.createElement('div');
                card.className = `card rounded-lg p-4 border ${borderClass} ${bgClass} transition hover:bg-slate-800`;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${icon}</span>
                            <div>
                                <div class="font-bold text-slate-200 text-sm flex items-center">
                                    ${email} ${sourceBadge}
                                </div>
                                <div class="text-xs text-slate-500">${date}</div>
                            </div>
                        </div>
                        <span class="text-xs px-2 py-1 bg-slate-900 rounded text-slate-400 capitalize">${item.type}</span>
                    </div>
                    ${contentHtml}
                `;
                container.appendChild(card);
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // üî• AUTO-LOGIN CHECK (Moved to bottom after functions are defined)
        if (sessionStorage.getItem(SESSION_KEY) === 'true') {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-content').classList.remove('hidden');
            loadFeedback();
        }
    </script>
</body>

</html>